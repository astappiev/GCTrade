function MapsIndexShop(){function a(a){var e=parseInt(a[0],10);return a[0]=-(parseInt(a[1],10)-2607),a[1]=19920+e,a}function e(){$.getJSON("/api/world/"+your_login,function(e){if(1==e.status){var o=[e.player.x,e.player.z];o=a(o);var n=map.unproject([o[0],o[1]],map.getMaxZoom());s++?t.setLatLng(n):(t=L.marker(n,{icon:p}),r.addLayer(t),map.setView(n,15))}else clearInterval(i),r.clearLayers()})}var r=new L.LayerGroup,o=new L.LayerGroup;map=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[r,o]}).setView([-.35764,.11951],13),L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:!0}).addTo(map),L.control.layers(null,{"Персонаж":r,"Магазины":o}).addTo(map);var n=L.icon({iconUrl:"/web/images/shop.png",iconSize:[36,36],iconAnchor:[18,18],popupAnchor:[0,-18]});if(your_login){var t,s=0,p=L.icon({iconUrl:"/api/head/"+your_login,iconSize:[32,32],iconAnchor:[16,16]}),i=setInterval(e,15e3);e()}$.getJSON("/api/shop",function(e){for(var r=e.length;r--;)if(e[r].x_cord&&e[r].z_cord){var t=[e[r].x_cord,e[r].z_cord];t=a(t);var s='<div class="shop-popup"><h4><a href="/shop/'+e[r].alias+'" target="_blank">'+e[r].name+"</a></h4>";e[r].logo_url&&(s+='<img src="'+e[r].logo_url+'">'),s+="<p>"+e[r].about+'</p><p class="plabel"><span class="label label-default">/go '+e[r].subway+'</span></p><p class="plabel"><a href="/shop/'+e[r].alias+'" target="_blank"><span class="label label-primary">Прайс</span></a> <span class="label label-success">X '+e[r].x_cord+", Z "+e[r].z_cord+"</span></p></div>";var p=L.marker(map.unproject([t[0],t[1]],map.getMaxZoom()),{icon:n}).bindPopup(s);o.addLayer(p)}}).fail(function(){$("#map").append('<div class="alert alert-danger" role="alert">Ошибка получения данных.</div>')})}function MapsUserRegions(){function a(a){var e=parseInt(a[0],10);return a[0]=-(parseInt(a[2],10)-2607),a[2]=19920+e,a}function e(a){for(var e=a.length;e--;)if(a[e]==userLogin)return!0;return!1}function r(r,o,n){rights=e(n.full_access),color=rights?"blue":"red",r=a(r),o=a(o);var t=L.rectangle([map.unproject([r[0],r[2]],map.getMaxZoom()),map.unproject([o[0],o[2]],map.getMaxZoom())],{color:color,weight:3,fillOpacity:.3}),s=n.parent?"<br><i>Родительский:</i> "+n.parent:"";t.bindPopup("<b>"+n.name+"</b>"+s+"<br><br><b>Владельцы:</b><br>"+n.full_access+"<br><b>Могут строить:</b><br>"+n.build_access).on("click",function(){this.bringToBack()}),rights?c.addLayer(t):l.addLayer(t)}function o(a,e){return a=a.toString(),a.length>e?a.slice(0,e-3)+"...":a}function n(a,e){return a.toString().replace(/\d(?=(?:\d{3})+\b)/g,"$&"+(e||" "))}function t(){var a=$(".usermap dl.dl-horizontal");$("#area",a).text(n(s)),$("#volume",a).text(n(p)),$("#cost",a).text(n(i)),$("#percent",a).text(o(100*s/area_world,15))}var s=0,p=0,i=0;$.ajax({type:"GET",url:"/api/regions",dataType:"json",async:!1,success:function(a){if("You must be logged in"==a.message)return void $("#map").append('<div class="alert alert-danger" role="alert">Сбой ауторизации.</div>').height("52px");if("It is a trouble with accessToken"==a.message)return void $("#map").append('<div class="alert alert-danger" role="alert">Ошибка Access_token-а, API GreenCubes не принимает наш ключик. Пишите Kernel-у.</div>').height("52px");if("Rate limit exceeded, retry later"==a.message)return void $("#map").append('<div class="alert alert-warning" role="alert">Вы исчерпали лимит запросов к GreenCubes API, попробуйте позже.</div>').height("52px");for(var e=a.length;e--;)$.ajax({type:"GET",url:"https://api.greencubes.org/main/regions/"+a[e].name,dataType:"json",success:function(a){if(a.name){pos1=a.coordinates.first.split(" "),pos2=a.coordinates.second.split(" ");var e=Math.abs(pos1[0]-pos2[0]),o=Math.abs(pos1[1]-pos2[1]),n=Math.abs(pos1[2]-pos2[2]);s+=e*n,p+=e*o*n,i+=Math.round(e*n*10+e*o*n*10/256),r(pos1,pos2,a),t()}}})}});var l=new L.LayerGroup,c=new L.LayerGroup,u=new L.LayerGroup;map=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[c,l,u]}).setView([-.35764,.11951],13),L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:!0}).addTo(map),L.control.layers(null,{"Полный доступ":c,"Частичный доступ":l,"Добавленые регионы":u}).addTo(map),$("#add-custom-regions").on("click",function(){var e=$("#customRegionTextarea").val();$("#customRegionModal").modal("hide");var r=e.split(/(?:,| |;|\n)+/);u.clearLayers();for(var o=r.length;o--;)$.ajax({type:"GET",url:"https://api.greencubes.org/main/regions/"+r[o],dataType:"json",success:function(e){if(e.name){pos1=e.coordinates.first.split(" "),pos2=e.coordinates.second.split(" "),pos1=a(pos1),pos2=a(pos2);var r=L.rectangle([map.unproject([pos1[0],pos1[2]],map.getMaxZoom()),map.unproject([pos2[0],pos2[2]],map.getMaxZoom())],{color:"orange",weight:3,fillOpacity:.4}),o=e.parent?"<br><i>Родительский:</i> "+e.parent:"";r.bindPopup("<b>"+e.name+"</b>"+o+"<br><br><b>Владельцы:</b><br>"+e.full_access+"<br><b>Могут строить:</b><br>"+e.build_access).on("click",function(){this.bringToBack()}),u.addLayer(r)}}})})}
