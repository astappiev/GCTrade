function MapsIndexShop(){function a(a){var e=parseInt(a[0],10);return a[0]=-(parseInt(a[1],10)-2607),a[1]=19920+e,a}function e(){$.getJSON("/api/world/"+your_login,function(e){if(1==e.status){var o=[e.player.x,e.player.z];o=a(o);var n=map.unproject([o[0],o[1]],map.getMaxZoom());s++?t.setLatLng(n):(t=L.marker(n,{icon:i}),r.addLayer(t),map.setView(n,15))}else clearInterval(l),r.clearLayers()})}var r=new L.LayerGroup,o=new L.LayerGroup;map=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[r,o]}).setView([-.35764,.11951],13),L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:!0}).addTo(map),L.control.layers(null,{"Персонаж":r,"Магазины":o}).addTo(map);var n=L.icon({iconUrl:"/web/images/shop.png",iconSize:[36,36],iconAnchor:[18,18],popupAnchor:[0,-18]});if(your_login){var t,s=0,i=L.icon({iconUrl:"/api/head/"+your_login,iconSize:[32,32],iconAnchor:[16,16]}),l=setInterval(e,15e3);e()}$.getJSON("/api/shop",function(e){for(var r=e.length;r--;)if(e[r].x_cord&&e[r].z_cord){var t=[e[r].x_cord,e[r].z_cord];t=a(t);var s='<div class="shop-popup"><h4><a href="/shop/'+e[r].alias+'" target="_blank">'+e[r].name+"</a></h4>";e[r].logo_url&&(s+='<img src="'+e[r].logo_url+'">'),s+="<p>"+e[r].about+'</p><p class="plabel"><span class="label label-default">/go '+e[r].subway+'</span></p><p class="plabel"><a href="/shop/'+e[r].alias+'" target="_blank"><span class="label label-primary">Прайс</span></a> <span class="label label-success">X '+e[r].x_cord+", Z "+e[r].z_cord+"</span></p></div>";var i=L.marker(map.unproject([t[0],t[1]],map.getMaxZoom()),{icon:n}).bindPopup(s);o.addLayer(i)}}).fail(function(){$("#map").append('<div class="alert alert-danger" role="alert">Ошибка получения данных.</div>')})}function MapsUserRegions(){function a(a){var e=parseInt(a[0],10);return a[0]=-(parseInt(a[2],10)-2607),a[2]=19920+e,a}function e(a){for(var e=a.length;e--;)if(a[e]==yii_login)return!0;return!1}function r(r,o,n){rights=e(n.full_access),color=rights?"blue":"red",r=a(r),o=a(o);var t=L.rectangle([map.unproject([r[0],r[2]],map.getMaxZoom()),map.unproject([o[0],o[2]],map.getMaxZoom())],{color:color,weight:3,fillOpacity:.3}),l=n.parent?"<br><i>Родительский:</i> "+n.parent:"";t.bindPopup("<b>"+n.name+"</b>"+l+"<br><br><b>Владельцы:</b><br>"+n.full_access+"<br><b>Могут строить:</b><br>"+n.build_access).on("click",function(){this.bringToBack()}),rights?i.addLayer(t):s.addLayer(t)}function o(a,e){return a=a.toString(),a.length>e?a.slice(0,e-3)+"...":a}function n(a,e){return a.toString().replace(/\d(?=(?:\d{3})+\b)/g,"$&"+(e||" "))}function t(){var a=$(".usermap dl.dl-horizontal");$("#area",a).text(n(l)),$("#volume",a).text(n(p)),$("#cost",a).text(n(c)),$("#percent",a).text(o(100*l/area_world,15))}if($("#customRegionTextarea").autosize(),console.log(region_list),"Forbidden. Need authorization"==region_list.message)return void $("#map").append('<div class="alert alert-danger" role="alert">Ошибка Access_token-а, API GreenCubes не принимает наш ключик. Пишите Kernel-у.</div>');if("Rate limit exceeded, retry later"==region_list.message)return void $("#map").append('<div class="alert alert-warning" role="alert">Вы исчерпали лимит запросов к GreenCubes API, попробуйте позже.</div>');var s=new L.LayerGroup,i=new L.LayerGroup;map=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[i,s]}).setView([-.35764,.11951],13),L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:!0}).addTo(map),L.control.layers(null,{"Полный доступ":i,"Частичный доступ":s}).addTo(map);for(var l=0,p=0,c=0,u=region_list.length;u--;)$.ajax({type:"GET",url:"https://api.greencubes.org/main/regions/"+region_list[u].name,dataType:"json",success:function(a){if(a.name){pos1=a.coordinates.first.split(" "),pos2=a.coordinates.second.split(" ");var e=Math.abs(pos1[0]-pos2[0]),o=Math.abs(pos1[1]-pos2[1]),n=Math.abs(pos1[2]-pos2[2]);l+=e*n,p+=e*o*n,c+=Math.round(e*n*10+e*o*n*10/256),r(pos1,pos2,a),t()}}})}
